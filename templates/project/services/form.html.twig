{% extends 'base.html.twig' %}

{% block title %}{{ page_title }} - WebDev Admin{% endblock %}

{% block body %}
{{ form_start(form, {'attr': {'class': 'settings-form'}}) }}
    <div class="row">
        <div class="col-md-8">
            {% if not is_edit %}
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            Template
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Quick Start:</strong> Select a template category and choose a pre-defined service, or continue with manual entry.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form_row(form.template_category) }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {{ form_row(form.template_key) }}
                                </div>
                            </div>
                        </div>
                        <div id="template-info" class="alert alert-secondary d-none">
                            <h6><i class="fas fa-info-circle"></i> Template Information</h6>
                            <p id="template-description" class="mb-1"></p>
                            <p id="template-docker-image" class="mb-1"></p>
                            <div id="template-snippet-container" class="d-none">
                                <hr>
                                <h6>Docker Compose Snippet:</h6>
                                <pre id="template-snippet" class="bg-dark text-white p-2" style="max-height: 200px; overflow-y: auto; font-size: 0.85em;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %} 

            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-server"></i> 
                        Configuration
                    </h3>
                </div>
                
                <div class="card-body">
                    <div class="form-group">
                        {{ form_row(form.key) }}
                    </div>
                    <div class="form-group">
                        {{ form_row(form.name) }}
                    </div>

                    <div class="form-group">
                        {{ form_row(form.category) }}
                    </div>

                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            {{ form_widget(form.active) }}
                            {{ form_label(form.active) }}
                            <small class="form-text text-muted">
                                {{ form_help(form.active) }}
                            </small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form_row(form.port) }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form_row(form.subDomain) }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Service
                    </button>
                    <a href="{{ path('project_services') }}" class="btn btn-default">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-header">
                    <h3 class="card-title">Help & Information</h3>
                </div>
                <div class="card-body">
                    {% if not is_edit %}
                    <h6><strong>Available Templates</strong></h6>
                    <ul class="mb-3">
                        <li><strong>Database:</strong> MySQL, PostgreSQL, MongoDB, MariaDB</li>
                        <li><strong>Cache:</strong> Redis, Memcached, Valkey</li>
                        <li><strong>Search:</strong> Elasticsearch, OpenSearch, Meilisearch</li>
                        <li><strong>Queue:</strong> RabbitMQ, Kafka, ActiveMQ</li>
                        <li><strong>Mail:</strong> Mailpit, MailHog, Mailtrap</li>
                        <li><strong>Tools:</strong> PhpMyAdmin, Adminer, etc.</li>
                    </ul>
                    <hr>
                    {% endif %}
                    <h6><strong>Service Categories</strong></h6>
                    <ul class="list-unstyled">
                        <li><span class="badge badge-primary">Proxy</span> - Reverse proxies, load balancers</li>
                        <li><span class="badge badge-success">Database</span> - MySQL, PostgreSQL, etc.</li>
                        <li><span class="badge badge-info">Mail</span> - Email testing tools</li>
                        <li><span class="badge badge-warning">Cache</span> - Redis, Memcached</li>
                        <li><span class="badge badge-secondary">Tools</span> - Admin panels, utilities</li>
                        <li><span class="badge badge-dark">Other</span> - Miscellaneous services</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {{ form_widget(form._token) }}
{{ form_end(form, {'render_rest': false}) }}

{% if not is_edit %}
<script>
// Service templates data
const serviceTemplates = {{ templates_by_category|json_encode|raw }};

document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('service_template_category');
    const templateSelect = document.getElementById('service_template_key');
    const templateInfo = document.getElementById('template-info');
    const nameField = document.getElementById('service_name');
    const serviceCategoryField = document.getElementById('service_category');
    const portField = document.querySelector('input[id$="_port"]');
    const subDomainField = document.querySelector('input[id$="_subDomain"]');
    const activeCheckbox = document.querySelector('input[id$="_active"]');

    // Handle category change
    categorySelect.addEventListener('change', function() {
        const category = this.value;
        
        // Reset template select
        templateSelect.innerHTML = '<option value="">-- Select a template --</option>';
        templateSelect.disabled = !category;
        templateInfo.classList.add('d-none');
        
        if (category && serviceTemplates[category]) {
            // Populate template options
            Object.keys(serviceTemplates[category]).forEach(key => {
                const template = serviceTemplates[category][key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = template.name;
                templateSelect.appendChild(option);
            });
        }
    });

    // Handle template selection
    templateSelect.addEventListener('change', function() {
        const templateKey = this.value;
        const category = categorySelect.value;
        
        if (!templateKey || !category) {
            templateInfo.classList.add('d-none');
            return;
        }
        
        const template = serviceTemplates[category][templateKey];
        if (!template) return;
        
        // Show template info
        if (template.description) {
            document.getElementById('template-description').innerHTML = 
                '<strong>Description:</strong> ' + template.description;
        }
        if (template.docker_image) {
            document.getElementById('template-docker-image').innerHTML = 
                '<strong>Docker Image:</strong> <code>' + template.docker_image + '</code>';
        }
        
        // Show docker compose snippet
        if (template.docker_compose_snippet) {
            document.getElementById('template-snippet').textContent = template.docker_compose_snippet;
            document.getElementById('template-snippet-container').classList.remove('d-none');
        }
        
        templateInfo.classList.remove('d-none');
        
        // Auto-fill form fields
        if (template.webdev_config) {
            // Fill name
            if (template.webdev_config.name) {
                nameField.value = template.webdev_config.name;
            }
            
            // Fill category
            if (template.webdev_config.category) {
                serviceCategoryField.value = template.webdev_config.category;
            }
            
            // Fill port
            if (template.webdev_config.port && portField) {
                portField.value = template.webdev_config.port;
            }
            
            // Fill subdomain
            if (template.webdev_config.subDomain && subDomainField) {
                subDomainField.value = template.webdev_config.subDomain;
            } else if (template.subdomain_suggestion && subDomainField) {
                subDomainField.value = template.subdomain_suggestion;
            }
            
            // Fill active
            if (activeCheckbox) {
                activeCheckbox.checked = template.webdev_config.active || false;
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}

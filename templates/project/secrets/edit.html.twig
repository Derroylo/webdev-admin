{% extends 'base.html.twig' %}

{% block title %}{{ page_title }} - WebDev Admin{% endblock %}

{% block body %}
 {{ form_start(form, {'attr': {'class': 'settings-form'}}) }}
    <div class="row">
        <div class="col-md-8">
            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                       <i class="fas fa-upload"></i> 
                       Configuration
                    </h3>
                </div>
            
                <div class="card-body">                   
                    <div class="form-group">
                        {{ form_row(form.key) }}
                    </div>

                    <div class="form-group">
                        {{ form_row(form.missingMessage) }}
                    </div>

                </div>
            </div>

            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                       <i class="fas fa-upload"></i>
                       Source Configuration
                    </h3>
                </div>
            
                <div class="card-body">
                    <p class="text-muted">Where to find the secret</p>
                    
                    <div class="form-group">
                        {{ form_row(form.sourceKey) }}
                    </div>

                    <div class="form-group">
                        {{ form_row(form.sourceGroup) }}
                    </div>

                </div>
            </div>
            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                       <i class="fas fa-download">
                       </i> Target Configuration
                    </h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">Where to use the secret (at least one target required)</p>

                    <div class="form-group">
                        {{ form_row(form.targetFile) }}
                    </div>

                    <div class="form-group">
                        {{ form_row(form.targetEnvVar) }}
                    </div>

                    <hr>

                    <h5><i class="fas fa-clipboard-check"></i> Expected Values (Optional)</h5>
                    <p class="text-muted">Define expected secrets or variables for validation</p>

                    <div class="form-group">
                        {{ form_label(form.targetExpectedSecrets) }}
                        <div id="expected-secrets-collection" data-prototype="{{ form_widget(form.targetExpectedSecrets.vars.prototype)|e('html_attr') }}">
                            {% for secret in form.targetExpectedSecrets %}
                                <div class="expected-secret-item mb-2">
                                    <div class="input-group">
                                        {{ form_widget(secret) }}
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-danger remove-expected-secret">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2" id="add-expected-secret">
                            <i class="fas fa-plus"></i> Add Expected Secret
                        </button>
                        {{ form_help(form.targetExpectedSecrets) }}
                    </div>

                    <div class="form-group">
                        {{ form_label(form.targetExpectedVars) }}
                        <div id="expected-vars-collection" data-prototype="{{ form_widget(form.targetExpectedVars.vars.prototype)|e('html_attr') }}">
                            {% for var in form.targetExpectedVars %}
                                <div class="expected-var-item mb-2">
                                    <div class="input-group">
                                        {{ form_widget(var) }}
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-danger remove-expected-var">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2" id="add-expected-var">
                            <i class="fas fa-plus"></i> Add Expected Variable
                        </button>
                        {{ form_help(form.targetExpectedVars) }}
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Secret
            </button>
            <a href="{{ path('project_secrets') }}" class="btn btn-default">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>

        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-header">
                    <h3 class="card-title">About Secrets</h3>
                </div>
                <div class="card-body">
                    <p>Secrets allow you to manage sensitive configuration files and environment variables.</p>
                    <h6>Source</h6>
                    <ul>
                        <li><strong>Key:</strong> File name to search for</li>
                        <li><strong>Group:</strong> Optional subfolder</li>
                    </ul>
                    <h6>Target</h6>
                    <ul>
                        <li><strong>File:</strong> Copy to project file</li>
                        <li><strong>Env Var:</strong> Load as environment variables</li>
                    </ul>
                    <p class="mb-0"><small>See <a href="https://derroylo.github.io/reference/webdev_yml/secrets" target="_blank">documentation</a> for more details.</small></p>
                </div>
            </div>
        </div>
    </div>
    {{ form_widget(form._token) }}
{{ form_end(form, {'render_rest': false}) }}
{% endblock %}

{% block extra_javascripts %}
<script>
// Handle collections
document.addEventListener('DOMContentLoaded', function() {
    setupCollection('expected-secrets', 'expected-secret');
    setupCollection('expected-vars', 'expected-var');
    
    function setupCollection(prefix, itemClass) {
        const addButton = document.getElementById(`add-${prefix}`);
        const collectionHolder = document.getElementById(`${prefix}-collection`);
        
        if (!addButton || !collectionHolder) return;
        
        let index = collectionHolder.querySelectorAll(`.${itemClass}-item`).length;
        
        addButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            const prototype = collectionHolder.dataset.prototype;
            const newForm = prototype.replace(/__name__/g, index);
            
            const div = document.createElement('div');
            div.className = `${itemClass}-item mb-2`;
            div.innerHTML = `
                <div class="input-group">
                    ${newForm}
                    <div class="input-group-append">
                        <button type="button" class="btn btn-danger remove-${itemClass}">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
            `;
            
            collectionHolder.appendChild(div);
            index++;
            
            attachRemoveHandler(div.querySelector(`.remove-${itemClass}`));
        });
        
        function attachRemoveHandler(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                this.closest(`.${itemClass}-item`).remove();
            });
        }
        
        // Attach to existing items
        document.querySelectorAll(`.remove-${itemClass}`).forEach(attachRemoveHandler);
    }
});
</script>
{% endblock %}

